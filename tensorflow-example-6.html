<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>Tensorflow.js example 6</title>
    <meta name="description" content="Tensorflow.js example 1">
    <meta name="author" content="Meizano">
    <!-- Load the latest version of TensorFlow.js -->
    <!-- <script src="https://unpkg.com/@tensorflow/tfjs"></script> -->
    <!-- <script src="https://unpkg.com/@tensorflow-models/mobilenet"></script> -->
    <script src="js/tfjs/tf.min.js"></script>
    <script src="js/mobilenet/mobilenet.js"></script>
    <script src="js/knn-classifier/knn-classifier.min.js"></script>
</head>

<body>
    <div id="console"></div>

    <!-- Select an image that we will use to test -->
    <img id="uploadPreview" />
    <br/>
    <input id="uploadImage" type="file" name="myPhoto" onchange="onChangePredictImage();" />
    <input id="predictImage" type="button" name="predictButton" value="Predict" onclick="predictImage();" />

    <!-- button to train data -->
    <br/>
    <button id="Troides-helena">Add Troides helena</button>
    <button id="Graphium-agamemnon">Add Graphium agamemnon</button>
    <button id="Papilio-peranthus">Add Papilio peranthus</button>


    <!-- Load index.js after the content of the page -->
    <script>
        // Disable WEBGL-PACK to circumvent "Failed to link vertex and fragment" shaders error
        tf.ENV.set('WEBGL_PACK', false);

        let net;
        let consl = document.querySelector("#console");
        let image = document.getElementById('uploadPreview');
        const classifier = knnClassifier.create();

        // <!-- Preview image script -->
        // <!-- reference: https://stackoverflow.com/questions/18457340/how-to-preview-selected-image-in-input-type-file-in-popup-using-jquery -->
        function previewImage() {
            let file = document.getElementById("uploadImage").files[0];

            let oFReader = new FileReader();
            oFReader.onloadend = function (oFREvent) {
                image.src = oFREvent.target.result;
            };
            if (file) {
                oFReader.readAsDataURL(file);
            }

        };

        async function app() {
            let loadingText = "Loading mobilnet..";
            console.log(loadingText);
            consl.innerText = loadingText;

            // Load the model.
            net = await mobilenet.load();
            let loadingSuccessText = 'Sucessfully loaded model';
            console.log(loadingSuccessText);
            consl.innerText = loadingSuccessText;
        }

        app();

        // Reads an image from the webcam and associates it with a specific class
        // index.
        const addExample = classId => {
            console.log("add example..");
            // Get the intermediate activation of MobileNet 'conv_preds' and pass that
            // to the KNN classifier.
            const activation = net.infer(image, 'conv_preds');

            // Pass the intermediate activation to the classifier.
            classifier.addExample(activation, classId);
        };

        // When clicking a button, add an example for that class.
        document.getElementById('Troides-helena').addEventListener('click', () => addExample(0));
        document.getElementById('Graphium-agamemnon').addEventListener('click', () => addExample(1));
        document.getElementById('Papilio-peranthus').addEventListener('click', () => addExample(2));


        // Function to make a prediction through the model on our image.
        async function predictImage() {
            // Get the activation from mobilenet from image.
            const activation = net.infer(image, 'conv_preds');
            // Get the most likely class and confidences from the classifier module.
            const result = await classifier.predictClass(activation);
            console.log(result);

            const classes = ['Troides helena', 'Graphium agamemnon', 'Papilio peranthus'];
            consl.innerText = `
                prediction: ${classes[result.classIndex]}\n
                probability: ${result.confidences[result.classIndex]}
            `;

        }

        function onChangePredictImage() {
            let prom = new Promise(function (resolve, reject) {
                previewImage();
                consl.innerText = "";
            });
            prom.then(predictImage());
            console.log(prom);
        }
    </script>
</body>

</html>